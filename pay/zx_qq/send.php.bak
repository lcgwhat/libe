<?php
require_once 'inc.php';
require_once 'Swiftpay.class.php';

$orderid=$_GET['orderid'];
$price=$_GET['price'];

$data=array(
    'out_trade_no'=>$orderid,
    'device_info'=>'',
    'body'=>$orderid,
    'attach'=>'',
    'total_fee'=>$price*100,
    'notify_url'=>'http://'.$_SERVER['HTTP_HOST'].'/pay/zx_qq/notifyUrl.php',
);

$pay=new Swiftpay();
$pay->userid=$userid;
$pay->userkey=$userkey;
$result=$pay->submitOrder($data);
?>
<!doctype html>
<html>
<head>
<meta http-equiv="Content-type" content="text/html; charset=utf-8" />
<title>QQ扫码支付(<?php echo $orderid ?>)</title>

<style>
*{padding:0;margin:0;}
body{background-color:#f1f1f1;}
#main{margin:0 auto 50px auto;border:1px solid #ccc;border-radius:5px;background-color:#fff;width:400px;}
.content{padding:20px 15px}
dl{margin:15px 0;}
dl dd{padding:5px 0;color:#333;text-align:left;}
dl dd span{font-size:1.3em;}
.btn{display:block;background-color:#2BAD13;color:#fff;text-decoration:none;padding:8px 0;text-align:center;border-radius:3px;}
#logo{margin-top:30px;background:url(logo.png) center center no-repeat;height:50px;}
</style>
	<script type="text/javascript" src="/static/common/jquery.min.js"></script>
</head>

<body>
    <div id="main">
        <div id="title">订单号：<span id="orderid"><?php echo $orderid?></span>&nbsp;&nbsp;&nbsp;&nbsp;金额：<span><?php echo number_format($price,2,'.','') ?></span> 元</div>
        <div id="content">
            <?php if($result):?>
                <div id="QRimg"><img src="<?php echo $result?>"></div>
            <?php else:?>
                <div>获取二维码失败！</div>
            <?php endif;?>
        </div>
        <div id="QRmsg"><div id="msgContent" class="qr_default"><p>请使用QQ扫码支付扫描<br/>二维码以完成支付</p></div></div>
    </div>
</body>
</html>
<script>
function oderquery(t){
    var orderid='<?php echo $orderid ?>';
    $.post('queryOrder.php',{orderid:orderid},function(ret){
        if(ret=='ok'){
			$('#msgContent p').html('请稍候<br>正在处理付款结果...');
            window.location.href='returnUrl.php?orderid='+orderid;
        }
    });

    t=t+1;
    setTimeout('oderquery('+t+')',5000);
}

setTimeout('oderquery(1)',5000);
</script>
